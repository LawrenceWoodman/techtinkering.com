<!DOCTYPE html>
<html lang="en">

<head>
  <title>Beware of Immutable Lists for F# Parallel Processing</title>
  <meta charset="utf-8" />

  <meta name="description" content="Retro Computers, Programming, General Technical Tinkering"/>
  <meta name="keywords" content="Retro Vintage Programming Tinkering"/>

  <link rel="stylesheet" href="/css/sitestyle.css" media="screen" type="text/css" />
  <link rel="stylesheet" href="/css/html_pygments.css" media="screen" type="text/css" />

  <link rel="alternate" type="application/rss+xml" title="Techtinkering RSS Feed" href="http://feedproxy.google.com/TechTinkering" />

  <!-- Fix for ie 5&6 where id doesnt render transparent images properly-->
  <!--[if lte IE 6]>
    <script defer type="text/javascript" src="/js/pngfix.js"></script>
  <![endif]-->

  <!-- Allow html5 elements to be style properly for IE v8 and before -->
  <!--[if lt IE 9]>
    <script src="/js/html5.js"></script>
  <![endif]-->

  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=vlifesystems"></script>

  <!-- Begin Cookie Consent plugin by Silktide - http://silktide.com/cookieconsent -->
  <script type="text/javascript">
      window.cookieconsent_options = {"message":"This website uses cookies to ensure you get the best experience on our website","dismiss":"Got it!","learnMore":"More info","link":"/tandc/#privacy","theme":"dark-bottom"};
  </script>

  <script type="text/javascript" src="//s3.amazonaws.com/cc.silktide.com/cookieconsent.latest.min.js"></script>
  <!-- End Cookie Consent plugin -->

</head>

<body>

  <div class="container">

    <nav class="banner">
      <a class="brand" href="/">TechTinkering</a>

      <ul>
        <li
        
        ><a href="/">Home</a></li>

        <li
        
        ><a href="/archive">Archive</a></li>

        
        <li class="active"><a href="">Article</a></li>
        

        

        

        

        

        <li
        
        ><a href="/about">About</a></li>

      </ul>

      <a href="http://feedproxy.google.com/TechTinkering" title="Subscribe to TechTinkering's RSS Feed">
        <img class="bannerIcon" src="/images/feed-icon-28x28.png" alt="RSS Feed"/>
      </a>

      <!-- From: http://www.buttonshut.com/Get-Button-Huts-Code/Youtube-Buttons-831.html -->
      <a href="http://youtube.com/techtinkering" title="TechTinkering's YouTube Channel">
        <img class="bannerIcon" src="/images/youtube-small-square-32.png" alt="YouTube Channel"/>
      </a>

      <!-- From: http://www.buttonshut.com/Get-Button-Huts-Code/Twitter-Buttons-1124.html -->
      <a href="http://twitter.com/TechTinkering" title="@TechTinkering on Twitter">
        <img class="bannerIcon" src="/images/twitter-button-36.png" alt="@techtinkering on Twitter"/>
      </a>


      <!-- From: http://www.graphicsfuel.com/2011/05/email-icon-psd/ -->
      <a href="mailto:feedback@techtinkering.com" title="Email us, we'd love to hear from you">
        <img class="bannerIcon" src="/images/email.png" alt="Email"/>
      </a>

      <a href="https://github.com/lawrencewoodman/techtinkering.com" title="Fork TechTinkering On Github ">
        <img class="bannerIcon" src="/images/octocat_fluid.png" alt="Techtinkering Repo on  Github"/>
      </a>
    </nav>

    <div class="content">
      <div class="rightColumn">

  <div class="columnAd">
    <script type="text/javascript"><!--
    google_ad_client = "ca-pub-1613732348909658";
    /* 300x250 - TechTinkering */
    google_ad_slot = "8883223823";
    google_ad_width = 300;
    google_ad_height = 250;
    //-->
    </script>
    <script type="text/javascript"
    src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
    </script>
  </div>

  <h2>Latest Articles</h2>
  <ul class="briefPosts">
    
      <li><a href="/2014/06/22/how-to-make-thunderbird-feel-like-geary">How to Make Thunderbird Feel Like Geary</a></li>
    
      <li><a href="/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing">Beware of Immutable Lists for F# Parallel Processing</a></li>
    
      <li><a href="/2013/08/29/rendering-racket-package-scribblings-on-github-using-gh-pages">Rendering Racket Package Scribblings on Github Using gh-pages</a></li>
    
      <li><a href="/2013/05/29/programmable-character-sets-a-simple-alternative-to-bitmap-displays">Programmable Character Sets: A Simple Alternative to Bitmap Displays</a></li>
    
      <li><a href="/2013/05/10/adding-a-basic-stub-to-a-vic-20-assembly-language-program">Adding a Basic Stub to a Vic-20 Assembly Language Program</a></li>
    
  </ul>

  <h2>Popular Tags</h2>
  <div>
    <a style='font-size: 110%' href='/tag/ruby'>Ruby</a>
<a style='font-size: 70%' href='/tag/textmode'>Text mode</a>
<a style='font-size: 70%' href='/tag/jupiterace'>Jupiter Ace</a>
<a style='font-size: 70%' href='/tag/computerarchitecure'>Computer Architecure</a>
<a style='font-size: 110%' href='/tag/cpm'>CP/M</a>
<a style='font-size: 88%' href='/tag/oisc'>OISC</a>
<a style='font-size: 101%' href='/tag/dec'>DEC</a>
<a style='font-size: 88%' href='/tag/bbs'>BBS</a>
<a style='font-size: 88%' href='/tag/book'>Book</a>
<a style='font-size: 119%' href='/tag/assembly'>Assembly</a>
<a style='font-size: 172%' href='/tag/tutorial'>Tutorial</a>
<a style='font-size: 101%' href='/tag/review'>Review</a>
<a style='font-size: 88%' href='/tag/tcltk'>Tcl/Tk</a>
<a style='font-size: 70%' href='/tag/offtopic'>Off Topic</a>
<a style='font-size: 131%' href='/tag/emulation'>Emulation</a>
<a style='font-size: 88%' href='/tag/subleq'>SUBLEQ</a>
<a style='font-size: 70%' href='/tag/jekyll'>Jekyll</a>
<a style='font-size: 70%' href='/tag/z80'>Z80</a>
<a style='font-size: 101%' href='/tag/pdp-8'>PDP-8</a>
<a style='font-size: 88%' href='/tag/vic-20'>Vic-20</a>
<a style='font-size: 70%' href='/tag/editors'>Editors</a>
<a style='font-size: 70%' href='/tag/imsai'>IMSAI</a>
<a style='font-size: 70%' href='/tag/history'>History</a>
<a style='font-size: 70%' href='/tag/parallelprocessing'>Parallel Processing</a>
<a style='font-size: 101%' href='/tag/games'>Games</a>
<a style='font-size: 70%' href='/tag/8080'>8080</a>
<a style='font-size: 88%' href='/tag/dos'>DOS</a>
<a style='font-size: 70%' href='/tag/adventuregames'>Adventure Games</a>
<a style='font-size: 70%' href='/tag/c'>C</a>
<a style='font-size: 200%' href='/tag/retro'>Retro</a>
<a style='font-size: 178%' href='/tag/programming'>Programming</a>
<a style='font-size: 70%' href='/tag/debugging'>Debugging</a>
<a style='font-size: 101%' href='/tag/commodore'>Commodore</a>
<a style='font-size: 119%' href='/tag/linux'>Linux</a>
<a style='font-size: 70%' href='/tag/webscraping'>Web Scraping</a>
<a style='font-size: 88%' href='/tag/webdevelopment'>Web Development</a>
<a style='font-size: 70%' href='/tag/xace'>xAce</a>

  </div>

</div>

<div class="leftColumn">
  <article itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <h1 itemprop="name"><a href="/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing" title="Beware of Immutable Lists for F# Parallel Processing">Beware of Immutable Lists for F# Parallel Processing</a></h1>
    <span class="byLine">
      by <span itemscope itemprop="author" itemtype="http://schema.org/Person">
           <a rel="author" itemprop="url" class="author" href="/profile/lawrencewoodman/">
             <span itemprop="name">Lawrence Woodman</span>
           </a>
         </span>
      <time itemprop="datePublished" datetime="2014-04-19">
        19 April 2014
      </time>
    </span>


    <!-- AddThis Button BEGIN -->
    <div style="float: right;" class="addthis_toolbox addthis_default_style addthis_32x32_style">
    <a class="addthis_button_google_plusone" g:plusone:count="false"></a>
    <a class="addthis_button_facebook"></a>
    <a class="addthis_button_twitter"></a>
    <a class="addthis_button_reddit"></a>
    <a class="addthis_button_compact"></a>
    </div>
    <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=vlifesystems"></script>
    <!-- AddThis Button END -->

    <span class="tagLine">
      <br />
      Tags:
      
        <a rel="tag" href="/tag/f">F#</a> &nbsp; &nbsp;
      
        <a rel="tag" href="/tag/parallelprocessing">Parallel Processing</a> &nbsp; &nbsp;
      
        <a rel="tag" href="/tag/programming">Programming</a> &nbsp; &nbsp;
      
    </span>

  </header>

  <div class="articleBody" itemprop="articleBody">
    <p>With F#, the <em>list</em> often feels like the default choice of data structure.  It is immutable and hence easy to reason about, however its use can come at a great cost.  If you are using lists to process large amounts of data, then a lot of time will be spent creating objects and garbage collecting.  When I stress tested lists with F#, it became clear that this can cause a major synchronization issue when parallel processing.  In fact, I was often seeing programs written in parallel which were effectively just context switching between threads rather than running in parallel.</p>

<h1>Investigating an Answer</h1>

<p>I tried to find an answer to this problem and posted on stackoverflow: <a href="http://stackoverflow.com/questions/22778028/how-to-execute-a-function-that-creates-a-lot-of-objects-in-parallel">How to execute a function, that creates a lot of objects, in parallel?</a>.  This didn't lead to an answer, which left me with two options:</p>

<ol>
<li>Keep the immutable lists but use a serialization strategy to bring data in and out of a program that runs as a single processes.  Then use another program to distribute that data to each program and run them in parallel.</li>
<li>Switch to mutable data structures to reduce the synchronization problems and time spent creating objects and garbage collecting.</li>
</ol>


<p>My preference is for immutable data structures, however serializing data in and out can be slow depending on what is being processed and this ugly hack removed much of the beauty and transparency of using immutable data structures.  I therefore decided to investigate the effect of switching to mutable data structures to see what a difference this would make.  The difference was huge.</p>

<h1>An Example Program Using Immutable Lists</h1>

<p>The script below (<code>program-noclass-list.fsx</code>) is a very basic data categorizer which relies on a field having a certain value as a rule to determine if this will predict a category.</p>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">// Filename: program-noclass-list.fsx</span>
<span class="k">open</span> <span class="nn">System</span>

<span class="k">type</span> <span class="nc">CategoryAssessment</span> <span class="o">=</span>
    <span class="o">{</span> <span class="n">fieldIndex</span><span class="o">:</span> <span class="n">int</span>
      <span class="n">value</span><span class="o">:</span> <span class="n">int</span>
      <span class="n">ruleAssessments</span><span class="o">:</span> <span class="kt">list</span><span class="o">&lt;</span><span class="n">int</span><span class="o">&gt;</span> <span class="o">}</span>

<span class="k">let</span> <span class="nv">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">ruleAssessments</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">rules</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="o">)</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">categorizeField</span> <span class="o">-&gt;</span>
                 <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">categorizeField</span>
                 <span class="o">{</span> <span class="nn">CategoryAssessment</span><span class="p">.</span><span class="n">fieldIndex</span> <span class="o">=</span> <span class="n">fieldIndex</span><span class="o">;</span>
                   <span class="n">value</span> <span class="o">=</span> <span class="n">categoryValue</span><span class="o">;</span>
                   <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">ruleAssessments</span> <span class="o">})</span>
             <span class="n">categorizeFields</span>

<span class="k">let</span> <span class="nv">AssessCategory</span> <span class="n">ruleMatches</span> <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="n">categoryAssessment</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">fieldIndex</span>
    <span class="k">let</span> <span class="nv">categoryValue</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">value</span>
    <span class="k">let</span> <span class="nv">categoryMatch</span> <span class="o">=</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span>
    <span class="k">let</span> <span class="nv">newRuleAssessments</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span><span class="k">fun</span> <span class="n">ruleAssessment</span> <span class="n">ruleMatch</span> <span class="o">-&gt;</span>
                       <span class="k">if</span> <span class="n">ruleMatch</span> <span class="o">=</span> <span class="n">categoryMatch</span> <span class="k">then</span>
                           <span class="n">ruleAssessment</span> <span class="o">+</span> <span class="mi">1</span>
                       <span class="k">else</span>
                           <span class="n">ruleAssessment</span><span class="o">)</span>
                  <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">ruleAssessments</span>
                  <span class="n">ruleMatches</span>
    <span class="o">{</span> <span class="n">categoryAssessment</span> <span class="k">with</span> <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">newRuleAssessments</span> <span class="o">}</span>

<span class="k">let</span> <span class="nv">MatchRule</span> <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="n">rule</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">eqVal</span> <span class="o">=</span> <span class="n">rule</span>
    <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span> <span class="o">=</span> <span class="n">eqVal</span>

<span class="k">let</span> <span class="nv">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="n">input</span> <span class="o">=</span>
  <span class="n">printfn</span> <span class="s">&quot;START - Assess&quot;</span>
  <span class="k">let</span> <span class="nv">d</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">categoryAssessment</span> <span class="n">row</span> <span class="o">-&gt;</span>
                 <span class="k">let</span> <span class="nv">ruleMatches</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">MatchRule</span> <span class="n">row</span><span class="o">)</span> <span class="n">rules</span>
                 <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">AssessCategory</span> <span class="n">ruleMatches</span> <span class="n">row</span><span class="o">)</span> <span class="n">categoryAssessment</span><span class="o">)</span>
               <span class="o">(</span><span class="n">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span><span class="o">)</span>
               <span class="n">input</span>
  <span class="n">printfn</span> <span class="s">&quot;END - Assess&quot;</span>
  <span class="n">d</span>

<span class="k">let</span> <span class="nv">JoinAssessments</span> <span class="n">assessments</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">numAssessments</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">assessments</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">accAssessment</span> <span class="n">assessment</span> <span class="o">-&gt;</span>
                    <span class="nn">List</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span><span class="k">fun</span> <span class="n">accCategory</span> <span class="n">category</span> <span class="o">-&gt;</span>
                                   <span class="k">let</span> <span class="nv">newRuleAssessments</span> <span class="o">=</span>
                                       <span class="nn">List</span><span class="p">.</span><span class="n">map2</span> <span class="o">(+)</span>
                                                 <span class="n">accCategory</span><span class="o">.</span><span class="n">ruleAssessments</span>
                                                 <span class="n">category</span><span class="o">.</span><span class="n">ruleAssessments</span>
                                   <span class="o">{</span> <span class="n">accCategory</span> <span class="k">with</span>
                                         <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">newRuleAssessments</span> <span class="o">})</span>
                              <span class="n">accAssessment</span>
                              <span class="n">assessment</span><span class="o">)</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">1</span><span class="o">..(</span><span class="n">numAssessments</span><span class="o">-</span><span class="mi">1</span><span class="o">)]</span>


<span class="k">let</span> <span class="nv">numRecords</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="k">let</span> <span class="nv">numFields</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">let</span> <span class="nv">numSplits</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">let</span> <span class="nv">numRules</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="k">let</span> <span class="nv">inputs</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">numSplits</span>
                          <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="o">(</span><span class="n">numRecords</span> <span class="o">/</span> <span class="n">numSplits</span><span class="o">)</span> <span class="o">-&gt;</span>
                                <span class="o">[|</span> <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numFields</span> <span class="o">-&gt;</span>
                                       <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="o">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">|]</span> <span class="o">|]</span>
<span class="k">let</span> <span class="nv">categorizeFields</span> <span class="o">=</span> <span class="o">[</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">]</span>
<span class="k">let</span> <span class="nv">rules</span> <span class="o">=</span> <span class="o">[</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numRules</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">numFields</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">]</span>

<span class="k">let</span> <span class="nv">assessments</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="nn">Parallel</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span><span class="o">)</span> <span class="n">inputs</span>
    <span class="o">|&gt;</span> <span class="n">JoinAssessments</span>
<span class="n">printfn</span> <span class="s">&quot;Assessments: %A&quot;</span> <span class="n">assessments</span>
<span class="mi">0</span></code></pre></div>


<h1>Improvements</h1>

<p>I made two main improvements, both involving moving to arrays.  The programs can be seen in full at the end of this article and the benchmarks in the next section.</p>

<dl>
  <dt>program-no-class-array.fsx</dt>
  <dd>First I switched all the lists to arrays.  This would reduce the amount of memory allocation and garbage collection and hence synchronization issues.  Although arrays are mutable, I used them in an immutable way.</dd>

  <dt>program-no-class-mutable-array.fsx</dt>
  <dd>Secondly I made the record field for the arrays mutable and again reduced the time creating objects and garbage collecting.</dd>

  <dt>program-class-mutable-array.fsx</dt>
  <dd>The switch to mutable arrays made a big difference, but I wanted to regain some control of the mutability and hence created a <em>class</em> to improve access control.</dd>
</dl>


<h1>Benchmarks</h1>

<p>You can see below that the biggest difference was made by switching from lists to arrays and that still more could be done by moving to mutable arrays.</p>

<table class="neatTable">
  <tr><th>Filename</th><th>User time</th><th>Elapsed time</th><th>CPU usage</th></tr>
  <tr><td>program-noclass-list.fsx</td><td>1568.44</td><td>23:11.65</td><td>115%</td></tr>
  <tr><td>program-noclass-array.fsx</td><td>83.09</td><td>0:59.14</td><td>142%</td></tr>
  <tr><td>program-class-mutable-array.fsx</td><td>60.57</td><td>0:35.64</td><td>172%</td></tr>
  <tr><td>program-noclass-mutable-array.fsx</td><td>55.82</td><td>0:33.19</td><td>172%</td></tr>
</table>


<p>For those interested here are the benchmarks for the same programs run on a single thread (by changing the <code>numSplits</code> line to equal <code>1</code>).  This demonstrates the problem with <code>program-noclass-list.fsx</code> as it actually runs quicker with a single thread than it does in parallel.  It also shows the problem with lists in general where performance is an issue.</p>

<table class="neatTable">
  <tr><th>Filename</th><th>User time</th><th>Elapsed time</th><th>CPU usage</th></tr>
  <tr><td>program-noclass-list.fsx</td><td>1154.09</td><td>20:02.16</td><td>99%</td></tr>
  <tr><td>program-noclass-array.fsx</td><td>81.99</td><td>1:23.42</td><td>99%</td></tr>
  <tr><td>program-class-mutable-array.fsx</td><td>61.73</td><td>1:06.60</td><td>94%</td></tr>
  <tr><td>program-noclass-mutable-array.fsx</td><td>51.83</td><td>0:52.87</td><td>100%</td></tr>
</table>


<h2>Where Now?</h2>

<p>It is important to pick the correct data structures for the job at hand.  As <a href="http://en.wikipedia.org/wiki/Niklaus_Wirth">Wirth</a> said "Algorithms + Data Structures = Programs".  While <em>list</em>s are a great default data structure in F#, where performance is an issue it can be seen how important it is to look beyond this, particularly when using multiple threads.</p>

<hr />

<h1>Full Source Code for Programs</h1>

<h2>program-noclass-array.fsx</h2>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">// Filename: program-noclass-array.fsx</span>
<span class="k">open</span> <span class="nn">System</span>

<span class="k">type</span> <span class="nc">CategoryAssessment</span> <span class="o">=</span>
    <span class="o">{</span> <span class="n">fieldIndex</span><span class="o">:</span> <span class="n">int</span>
      <span class="n">value</span><span class="o">:</span> <span class="n">int</span>
      <span class="n">ruleAssessments</span><span class="o">:</span> <span class="n">int</span><span class="bp">[]</span> <span class="o">}</span>

<span class="k">let</span> <span class="nv">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">ruleAssessments</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">rules</span><span class="o">)</span> <span class="mi">0</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">categorizeField</span> <span class="o">-&gt;</span>
                   <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">categorizeField</span>
                   <span class="o">{</span> <span class="nn">CategoryAssessment</span><span class="p">.</span><span class="n">fieldIndex</span> <span class="o">=</span> <span class="n">fieldIndex</span><span class="o">;</span>
                     <span class="n">value</span> <span class="o">=</span> <span class="n">categoryValue</span><span class="o">;</span>
                     <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">ruleAssessments</span> <span class="o">})</span>
              <span class="n">categorizeFields</span>

<span class="k">let</span> <span class="nv">AssessCategory</span> <span class="n">ruleMatches</span> <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="n">categoryAssessment</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">fieldIndex</span>
    <span class="k">let</span> <span class="nv">categoryValue</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">value</span>
    <span class="k">let</span> <span class="nv">categoryMatch</span> <span class="o">=</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span>
    <span class="k">let</span> <span class="nv">newRuleAssessments</span> <span class="o">=</span>
        <span class="nn">Array</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span><span class="k">fun</span> <span class="n">ruleAssessment</span> <span class="n">ruleMatch</span> <span class="o">-&gt;</span>
                        <span class="k">if</span> <span class="n">ruleMatch</span> <span class="o">=</span> <span class="n">categoryMatch</span> <span class="k">then</span>
                            <span class="n">ruleAssessment</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">else</span>
                            <span class="n">ruleAssessment</span><span class="o">)</span>
                   <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">ruleAssessments</span>
                   <span class="n">ruleMatches</span>
    <span class="o">{</span> <span class="n">categoryAssessment</span> <span class="k">with</span> <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">newRuleAssessments</span> <span class="o">}</span>

<span class="k">let</span> <span class="nv">MatchRule</span> <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="n">rule</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">eqVal</span> <span class="o">=</span> <span class="n">rule</span>
    <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span> <span class="o">=</span> <span class="n">eqVal</span>

<span class="k">let</span> <span class="nv">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="n">input</span> <span class="o">=</span>
  <span class="n">printfn</span> <span class="s">&quot;START - Assess&quot;</span>
  <span class="k">let</span> <span class="nv">d</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">categoryAssessment</span> <span class="n">row</span> <span class="o">-&gt;</span>
                 <span class="k">let</span> <span class="nv">ruleMatches</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">MatchRule</span> <span class="n">row</span><span class="o">)</span> <span class="n">rules</span>
                 <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">AssessCategory</span> <span class="n">ruleMatches</span> <span class="n">row</span><span class="o">)</span> <span class="n">categoryAssessment</span><span class="o">)</span>
               <span class="o">(</span><span class="n">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span><span class="o">)</span>
               <span class="n">input</span>
  <span class="n">printfn</span> <span class="s">&quot;END - Assess&quot;</span>
  <span class="n">d</span>

<span class="k">let</span> <span class="nv">JoinAssessments</span> <span class="n">assessments</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">numAssessments</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">assessments</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">accAssessment</span> <span class="n">assessment</span> <span class="o">-&gt;</span>
                    <span class="nn">Array</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span><span class="k">fun</span> <span class="n">accCategory</span> <span class="n">category</span> <span class="o">-&gt;</span>
                                    <span class="k">let</span> <span class="nv">newRuleAssessments</span> <span class="o">=</span>
                                        <span class="nn">Array</span><span class="p">.</span><span class="n">map2</span> <span class="o">(+)</span>
                                                   <span class="n">accCategory</span><span class="o">.</span><span class="n">ruleAssessments</span>
                                                   <span class="n">category</span><span class="o">.</span><span class="n">ruleAssessments</span>
                                    <span class="o">{</span> <span class="n">accCategory</span> <span class="k">with</span>
                                          <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">newRuleAssessments</span> <span class="o">})</span>
                               <span class="n">accAssessment</span>
                               <span class="n">assessment</span><span class="o">)</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">1</span><span class="o">..(</span><span class="n">numAssessments</span><span class="o">-</span><span class="mi">1</span><span class="o">)]</span>


<span class="k">let</span> <span class="nv">numRecords</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="k">let</span> <span class="nv">numFields</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">let</span> <span class="nv">numSplits</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">let</span> <span class="nv">numRules</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="k">let</span> <span class="nv">inputs</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">numSplits</span>
                          <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="o">(</span><span class="n">numRecords</span> <span class="o">/</span> <span class="n">numSplits</span><span class="o">)</span> <span class="o">-&gt;</span>
                                <span class="o">[|</span> <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numFields</span> <span class="o">-&gt;</span>
                                       <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="o">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">|]</span> <span class="o">|]</span>
<span class="k">let</span> <span class="nv">categorizeFields</span> <span class="o">=</span> <span class="o">[|</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">|]</span>
<span class="k">let</span> <span class="nv">rules</span> <span class="o">=</span> <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numRules</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">numFields</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">|]</span>

<span class="k">let</span> <span class="nv">assessments</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="nn">Parallel</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span><span class="o">)</span> <span class="n">inputs</span>
    <span class="o">|&gt;</span> <span class="n">JoinAssessments</span>
<span class="n">printfn</span> <span class="s">&quot;Assessments: %A&quot;</span> <span class="n">assessments</span>
<span class="mi">0</span></code></pre></div>


<h2>program-noclass-mutable-array.fsx</h2>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">// Filename: program-noclass-mutable-array.fsx</span>
<span class="k">open</span> <span class="nn">System</span>

<span class="k">type</span> <span class="nc">CategoryAssessment</span> <span class="o">=</span>
    <span class="o">{</span> <span class="n">fieldIndex</span><span class="o">:</span> <span class="n">int</span>
      <span class="n">value</span><span class="o">:</span> <span class="n">int</span>
      <span class="k">mutable</span> <span class="n">ruleAssessments</span><span class="o">:</span> <span class="n">int</span><span class="bp">[]</span> <span class="o">}</span>

<span class="k">let</span> <span class="nv">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">categorizeField</span> <span class="o">-&gt;</span>
                   <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">categorizeField</span>
                   <span class="k">let</span> <span class="nv">ruleAssessments</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">rules</span><span class="o">)</span> <span class="mi">0</span>
                   <span class="o">{</span> <span class="nn">CategoryAssessment</span><span class="p">.</span><span class="n">fieldIndex</span> <span class="o">=</span> <span class="n">fieldIndex</span><span class="o">;</span>
                     <span class="n">value</span> <span class="o">=</span> <span class="n">categoryValue</span><span class="o">;</span>
                     <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">ruleAssessments</span> <span class="o">})</span>
              <span class="n">categorizeFields</span>

<span class="k">let</span> <span class="nv">AssessCategory</span> <span class="n">ruleMatches</span> <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="n">categoryAssessment</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">fieldIndex</span>
    <span class="k">let</span> <span class="nv">categoryValue</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">value</span>
    <span class="k">let</span> <span class="nv">categoryMatch</span> <span class="o">=</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">ruleMatch</span> <span class="o">-&gt;</span>
                     <span class="k">if</span> <span class="n">ruleMatch</span> <span class="o">=</span> <span class="n">categoryMatch</span> <span class="k">then</span>
                         <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">ruleAssessments</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;-</span>
                             <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">ruleAssessments</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
                <span class="n">ruleMatches</span>

<span class="k">let</span> <span class="nv">MatchRule</span> <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="n">rule</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">eqVal</span> <span class="o">=</span> <span class="n">rule</span>
    <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span> <span class="o">=</span> <span class="n">eqVal</span>

<span class="k">let</span> <span class="nv">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="n">input</span> <span class="o">=</span>
      <span class="k">let</span> <span class="nv">assessment</span> <span class="o">=</span> <span class="n">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span>
      <span class="n">printfn</span> <span class="s">&quot;START - Assess&quot;</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
                      <span class="k">let</span> <span class="nv">ruleMatches</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">MatchRule</span> <span class="n">row</span><span class="o">)</span> <span class="n">rules</span>
                      <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">AssessCategory</span> <span class="n">ruleMatches</span> <span class="n">row</span><span class="o">)</span> <span class="n">assessment</span><span class="o">)</span>
                 <span class="n">input</span>
      <span class="n">printfn</span> <span class="s">&quot;END - Assess&quot;</span>
      <span class="n">assessment</span>

<span class="k">let</span> <span class="nv">JoinAssessments</span> <span class="n">assessments</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">numAssessments</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">assessments</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">accAssessment</span> <span class="n">assessment</span> <span class="o">-&gt;</span>
                    <span class="nn">Array</span><span class="p">.</span><span class="n">map2</span> <span class="o">(</span><span class="k">fun</span> <span class="n">accCategory</span> <span class="n">category</span> <span class="o">-&gt;</span>
                                    <span class="k">let</span> <span class="nv">newRuleAssessments</span> <span class="o">=</span>
                                        <span class="nn">Array</span><span class="p">.</span><span class="n">map2</span> <span class="o">(+)</span>
                                                   <span class="n">accCategory</span><span class="o">.</span><span class="n">ruleAssessments</span>
                                                   <span class="n">category</span><span class="o">.</span><span class="n">ruleAssessments</span>
                                    <span class="o">{</span> <span class="n">accCategory</span> <span class="k">with</span>
                                          <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="n">newRuleAssessments</span> <span class="o">})</span>
                               <span class="n">accAssessment</span>
                               <span class="n">assessment</span><span class="o">)</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">1</span><span class="o">..(</span><span class="n">numAssessments</span><span class="o">-</span><span class="mi">1</span><span class="o">)]</span>


<span class="k">let</span> <span class="nv">numRecords</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="k">let</span> <span class="nv">numFields</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">let</span> <span class="nv">numSplits</span> <span class="o">=</span> <span class="mi">10</span>
<span class="k">let</span> <span class="nv">numRules</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="k">let</span> <span class="nv">inputs</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">numSplits</span>
                          <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="o">(</span><span class="n">numRecords</span> <span class="o">/</span> <span class="n">numSplits</span><span class="o">)</span> <span class="o">-&gt;</span>
                                <span class="o">[|</span> <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numFields</span> <span class="o">-&gt;</span>
                                       <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="o">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">|]</span> <span class="o">|]</span>
<span class="k">let</span> <span class="nv">categorizeFields</span> <span class="o">=</span> <span class="o">[|</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">|]</span>
<span class="k">let</span> <span class="nv">rules</span> <span class="o">=</span> <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numRules</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">numFields</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">|]</span>

<span class="k">let</span> <span class="nv">assessments</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="nn">Parallel</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span><span class="o">)</span> <span class="n">inputs</span>
    <span class="o">|&gt;</span> <span class="n">JoinAssessments</span>
<span class="n">printfn</span> <span class="s">&quot;Assessments: %A&quot;</span> <span class="n">assessments</span>
<span class="mi">0</span></code></pre></div>


<h2>program-class-mutable-array.fsx</h2>

<div class="highlight"><pre><code class="language-fsharp" data-lang="fsharp"><span class="c1">// Filename: program-class-mutable-array.fsx</span>
<span class="k">open</span> <span class="nn">System</span>

<span class="k">type</span> <span class="nc">CategoryAssessment</span><span class="o">(</span><span class="n">fieldIndex</span> <span class="o">:</span> <span class="n">int</span><span class="o">,</span>
                        <span class="n">categoryValue</span> <span class="o">:</span> <span class="n">int</span><span class="o">,</span>
                        <span class="n">numRules</span> <span class="o">:</span> <span class="n">int</span><span class="o">)</span> <span class="o">=</span> <span class="k">class</span>
    <span class="k">let</span> <span class="nv">mutable</span> <span class="n">ruleAssessments</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">numRules</span> <span class="mi">0</span>
    <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">FieldIndex</span> <span class="o">=</span> <span class="n">fieldIndex</span>
    <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Value</span> <span class="o">=</span> <span class="n">categoryValue</span>
    <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">RuleAssessments</span> <span class="o">=</span> <span class="n">ruleAssessments</span>
    <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">IsSimilar</span><span class="o">(</span><span class="n">otherCategoryAssessment</span> <span class="o">:</span> <span class="n">CategoryAssessment</span><span class="o">)</span> <span class="o">=</span>
        <span class="n">x</span><span class="o">.</span><span class="n">FieldIndex</span> <span class="o">=</span> <span class="n">otherCategoryAssessment</span><span class="o">.</span><span class="n">FieldIndex</span> <span class="o">&amp;&amp;</span>
        <span class="n">x</span><span class="o">.</span><span class="n">Value</span> <span class="o">=</span> <span class="n">otherCategoryAssessment</span><span class="o">.</span><span class="n">Value</span> <span class="o">&amp;&amp;</span>
        <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">ruleAssessments</span> <span class="o">=</span>
            <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">otherCategoryAssessment</span><span class="o">.</span><span class="n">RuleAssessments</span>
    <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">Merge</span><span class="o">(</span><span class="n">otherCategoryAssessment</span> <span class="o">:</span> <span class="n">CategoryAssessment</span><span class="o">)</span> <span class="o">=</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">IsSimilar</span> <span class="n">otherCategoryAssessment</span> <span class="k">then</span>
            <span class="n">ruleAssessments</span> <span class="o">&lt;-</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map2</span> <span class="o">(+)</span>
                                          <span class="n">ruleAssessments</span>
                                          <span class="n">otherCategoryAssessment</span><span class="o">.</span><span class="n">RuleAssessments</span>
        <span class="k">else</span>
            <span class="n">failwith</span> <span class="s">&quot;ERROR: Can&#39;t merge with other CategoryAssessment&quot;</span>
    <span class="k">member</span> <span class="n">x</span><span class="p">.</span><span class="nf">UpRuleAssessment</span><span class="o">(</span><span class="n">index</span><span class="o">)</span> <span class="o">=</span>
        <span class="n">ruleAssessments</span><span class="o">.[</span><span class="n">index</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">ruleAssessments</span><span class="o">.[</span><span class="n">index</span><span class="o">]</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">override</span> <span class="n">this</span><span class="p">.</span><span class="nf">ToString</span><span class="bp">()</span> <span class="o">=</span>
        <span class="n">sprintf</span> <span class="s">&quot;{fieldIndex = %d; value = %d; ruleAssessments = %A }&quot;</span>
                <span class="n">this</span><span class="o">.</span><span class="n">FieldIndex</span>
                <span class="n">this</span><span class="o">.</span><span class="n">Value</span>
                <span class="n">this</span><span class="o">.</span><span class="n">RuleAssessments</span>
<span class="k">end</span>


<span class="k">let</span> <span class="nv">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">categorizeField</span> <span class="o">-&gt;</span>
                  <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">categorizeField</span>
                  <span class="k">new</span> <span class="n">CategoryAssessment</span><span class="o">(</span><span class="n">fieldIndex</span><span class="o">,</span>
                                         <span class="n">categoryValue</span><span class="o">,</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">rules</span><span class="o">))</span>
             <span class="n">categorizeFields</span>
    <span class="o">|&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">toArray</span>

<span class="k">let</span> <span class="nv">AssessCategory</span> <span class="n">ruleMatches</span>
                   <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span>
                   <span class="o">(</span><span class="n">categoryAssessment</span> <span class="o">:</span> <span class="n">CategoryAssessment</span><span class="o">)</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">FieldIndex</span>
    <span class="k">let</span> <span class="nv">categoryValue</span> <span class="o">=</span> <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">Value</span>
    <span class="k">let</span> <span class="nv">categoryMatch</span> <span class="o">=</span> <span class="n">categoryValue</span> <span class="o">=</span> <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>  <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">ruleMatch</span> <span class="o">-&gt;</span>
                      <span class="k">if</span> <span class="n">ruleMatch</span> <span class="o">=</span> <span class="n">categoryMatch</span> <span class="k">then</span>
                          <span class="n">categoryAssessment</span><span class="o">.</span><span class="n">UpRuleAssessment</span> <span class="n">i</span><span class="o">)</span>
                 <span class="n">ruleMatches</span>

<span class="k">let</span> <span class="nv">MatchRule</span> <span class="o">(</span><span class="n">row</span> <span class="o">:</span> <span class="n">int</span><span class="bp">[]</span><span class="o">)</span> <span class="n">rule</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">fieldIndex</span><span class="o">,</span> <span class="n">eqVal</span> <span class="o">=</span> <span class="n">rule</span>
    <span class="n">row</span><span class="o">.[</span><span class="n">fieldIndex</span><span class="o">]</span> <span class="o">=</span> <span class="n">eqVal</span>

<span class="k">let</span> <span class="nv">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span> <span class="n">input</span> <span class="o">=</span>
    <span class="n">printfn</span> <span class="s">&quot;START - Assess&quot;</span>
    <span class="k">let</span> <span class="nv">categoryAssessments</span> <span class="o">=</span> <span class="n">InitAssessment</span> <span class="n">categorizeFields</span> <span class="n">rules</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
                    <span class="k">let</span> <span class="nv">ruleMatches</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">MatchRule</span> <span class="n">row</span><span class="o">)</span> <span class="n">rules</span>
                    <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">AssessCategory</span> <span class="n">ruleMatches</span> <span class="n">row</span><span class="o">)</span>
                               <span class="n">categoryAssessments</span><span class="o">)</span>
               <span class="n">input</span>
    <span class="n">printfn</span> <span class="s">&quot;END - Assess&quot;</span>
    <span class="n">categoryAssessments</span>

<span class="k">let</span> <span class="nv">JoinAssessments</span> <span class="n">assessments</span> <span class="o">=</span>
    <span class="k">let</span> <span class="nv">numAssessments</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">assessments</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">accAssessment</span> <span class="n">assessment</span> <span class="o">-&gt;</span>
                    <span class="nn">Array</span><span class="p">.</span><span class="n">iter2</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">accCategory</span> <span class="o">:</span> <span class="n">CategoryAssessment</span><span class="o">)</span>
                                     <span class="o">(</span><span class="n">category</span> <span class="o">:</span> <span class="n">CategoryAssessment</span><span class="o">)</span> <span class="o">-&gt;</span>
                                     <span class="n">accCategory</span><span class="o">.</span><span class="n">Merge</span> <span class="n">category</span><span class="o">)</span>
                                <span class="n">accAssessment</span>
                                <span class="n">assessment</span>
                    <span class="n">accAssessment</span><span class="o">)</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span>
               <span class="n">assessments</span><span class="o">.[</span><span class="mi">1</span><span class="o">..(</span><span class="n">numAssessments</span><span class="o">-</span><span class="mi">1</span><span class="o">)]</span>


<span class="k">let</span> <span class="nv">numRecords</span> <span class="o">=</span> <span class="mi">1000000</span>
<span class="k">let</span> <span class="nv">numFields</span> <span class="o">=</span> <span class="mi">20</span>
<span class="k">let</span> <span class="nv">numSplits</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">let</span> <span class="nv">numRules</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="k">let</span> <span class="nv">inputs</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="n">numSplits</span>
                          <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="o">(</span><span class="n">numRecords</span> <span class="o">/</span> <span class="n">numSplits</span><span class="o">)</span> <span class="o">-&gt;</span>
                                <span class="o">[|</span> <span class="k">for</span> <span class="n">j</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numFields</span> <span class="o">-&gt;</span>
                                       <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="o">)</span> <span class="o">+</span> <span class="n">j</span> <span class="o">|]</span> <span class="o">|]</span>
<span class="k">let</span> <span class="nv">categorizeFields</span> <span class="o">=</span> <span class="o">[</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">6</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">);</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">4</span><span class="o">);</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span> <span class="o">]</span>
<span class="k">let</span> <span class="nv">rules</span> <span class="o">=</span> <span class="o">[|</span> <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="mi">1</span> <span class="o">..</span> <span class="n">numRules</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">i</span> <span class="o">%</span> <span class="n">numFields</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="o">|]</span>
<span class="k">let</span> <span class="nv">assessments</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="nn">Parallel</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">Assess</span> <span class="n">categorizeFields</span> <span class="n">rules</span><span class="o">)</span> <span class="n">inputs</span>
    <span class="o">|&gt;</span> <span class="n">JoinAssessments</span>
<span class="n">printfn</span> <span class="s">&quot;Assessments: %A&quot;</span> <span class="n">assessments</span>
<span class="mi">0</span></code></pre></div>




  </div>
</article>


  <div style="clear: left;"></div>

  
    <hr />
    <a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/">
      <img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/2.0/uk/88x31.png" />
    </a>
    <span xmlns:dc="http://purl.org/dc/elements/1.1/" href="http://purl.org/dc/dcmitype/Text" property="dc:title" rel="dc:type">
      Beware of Immutable Lists for F# Parallel Processing
    </span><br />

    by
    <a xmlns:cc="http://creativecommons.org/ns#" href="http://techtinkering.com/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing" property="cc:attributionName" rel="cc:attributionURL">
    TechTinkering
    </a>
     is licensed under a
    <a rel="license" href="http://creativecommons.org/licenses/by/2.0/uk/">
    Creative Commons Attribution 2.0 UK: England & Wales License
    </a>
  

  <hr style="clear:both;" />

  
    <h2>Related</h2>
    <ul class="briefPosts">
      
        <li><a href="/2009/12/02/setting-up-a-beowulf-cluster-using-open-mpi-on-linux">Setting up a Beowulf Cluster Using Open MPI on Linux</a></li>
      
        <li><a href="/2013/05/10/adding-a-basic-stub-to-a-vic-20-assembly-language-program">Adding a Basic Stub to a Vic-20 Assembly Language Program</a></li>
      
        <li><a href="/2013/05/04/creating-a-tty-simulator-in-assembly-language-on-the-vic-20">Creating a TTY Simulator in Assembly Language on the Vic-20</a></li>
      
        <li><a href="/2013/04/16/beginning-assembly-programming-on-the-commodore-vic-20">Beginning Assembly Programming on the Commodore Vic-20</a></li>
      
        <li><a href="/2013/03/12/if-only-borland-had-stuck-with-turbo-modula-2-for-cpm">If Only Borland Had Stuck With Turbo Modula-2 For CP/M</a></li>
      
    </ul>
  

  <hr />

  <div id="rightAd">
    <script type="text/javascript"><!--
    google_ad_client = "ca-pub-1613732348909658";
    /* 300x250 - TechTinkering */
    google_ad_slot = "8883223823";
    google_ad_width = 300;
    google_ad_height = 250;
    //-->
    </script>
    <script type="text/javascript"
    src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
    </script>
  </div>

  <h2>Bookmark and Share</h2>
  <a href="http://feedproxy.google.com/TechTinkering" title="Subscribe to TechTinkering's RSS Feed"><img class="bookmarkIcon" src="/images/feed-icon-28x28.png" alt="RSS Feed"/>
  </a> Subscribe to RSS feed<br />

  <!-- AddThis Button BEGIN -->
  <div class="addthis_toolbox addthis_default_style addthis_32x32_style" style="left:50px;top:50px;">
    <a class="addthis_button_google_plusone" g:plusone:count="false"></a> &nbsp; Share on Google+<br />
    <br />
    <a class="addthis_button_facebook"></a> &nbsp; Share on Facebook<br />
    <br />
    <a class="addthis_button_twitter"></a> &nbsp; Share on Twitter<br />
    <br />
    <a class="addthis_button_reddit"></a> &nbsp; Share on Reddit<br />
    <br />
    <a class="addthis_button_compact"></a> &nbsp; Share elsewhere<br />
  </div>
  <!-- AddThis Button END -->

  <hr style="clear:both;" />

  <div id="disqus_thread"></div>
  <script type="text/javascript">
    var disqus_shortname = 'techtinkering';
    var disqus_identifier = '/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing';
    var disqus_url = 'http://techtinkering.com/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

    </div>

    <footer>
      <strong>Legal:</strong> &nbsp;
      <a href="/tandc/">Terms</a>,
      <a href="/statinfo/">Statutory Information</a>

      &nbsp; &nbsp;
      <strong>RSS Feeds:</strong> &nbsp;
      <a href="http://feedproxy.google.com/TechTinkering" title="Subscribe to TechTinkering's RSS Feed">Full</a>,
      <a href="http://feeds.feedburner.com/Retro-Techtinkering" title="Subscribe to TechTinkering's Retro RSS Feed">Retro</a>
    </footer>
  </div>


  
  <script type="text/javascript" src="http://www.assoc-amazon.co.uk/s/link-enhancer?tag=techtinkering-21&amp;o=2">
  </script>
  <noscript>
      <img src="http://www.assoc-amazon.co.uk/s/noscript?tag=techtinkering-21" alt="" />
  </noscript>

  
  <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
  </script>
  <script type="text/javascript">
    try {
      var pageTracker = _gat._getTracker("UA-4388762-2");
      pageTracker._trackPageview();
    } catch(err) {}
  </script>

  </body>
</html>
