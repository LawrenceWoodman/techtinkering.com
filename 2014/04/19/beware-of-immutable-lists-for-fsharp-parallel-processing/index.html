<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>Beware of Immutable Lists for F# Parallel Processing</title>
  <meta name="description" content="With F#, the list often feels like the default choice of data structure.  It is immutable and hence easy to reason about, however its use can come at a great cos">
  <meta name="keywords" content="Retro Vintage Programming Tinkering"/>

  <!-- *** Twitter Card *** -->
  <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@techtinkering">
  <meta name="twitter:title" content="Beware of Immutable Lists for F# Parallel Processing">
  <meta name="twitter:description" content="With F#, the list often feels like the default choice of data structure.  It is immutable and hence easy to reason about, however its use can come at a great cos">
  <!-- *** Twitter Card *** -->

  <!-- *** Open Graph *** --->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Beware of Immutable Lists for F# Parallel Processing">
  <meta property="og:description" content="With F#, the list often feels like the default choice of data structure.  It is immutable and hence easy to reason about, however its use can come at a great cos">
  <meta property="og:url" content="http://techtinkering.com/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing/">
  <!-- *** Open Graph *** --->

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-4388762-2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-4388762-2');
  </script>

  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/prism.css" rel="stylesheet">
  <link href="/css/main.css" rel="stylesheet">
  <link href="/css/extra.css" rel="stylesheet">
  <link href="/css/article.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" rel="stylesheet" type="text/css" />
  <link rel="canonical" href="http://techtinkering.com/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing/">
  <link rel="alternate" type="application/rss+xml" title="TechTinkering - Retro Computers, Programming, General Technical Tinkering"
        href="http://feedproxy.google.com/TechTinkering" />

	<!-- ****** faviconit.com favicons ****** -->
	<link rel="shortcut icon" href="/favicon.ico">
	<link rel="icon" sizes="16x16 32x32 64x64" href="/favicon.ico">
	<!-- ****** faviconit.com favicons ****** -->

  <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">

  <script src="/js/jquery-3.3.1.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  <script src="/js/prism.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

  <script>
    // Cookie Consent - https://cookieconsent.insites.com
    window.addEventListener("load", function(){
    window.cookieconsent.initialise({
      "palette": {
        "popup": {
          "background": "#252e39"
        },
        "button": {
          "background": "#14a7d0"
        }
      },
      "theme": "classic",
      "position": "top",
      "static": true,
      "content": {
        "message": "TechTinkering uses cookies for advertising, analytics, etc.",
        "href": "http://techtinkering.com/privacy/"
      }
    })});
  </script>

  <script>
    (adsbygoogle = window.adsbygoogle || []).push({
         google_ad_client: "ca-pub-1613732348909658",
         enable_page_level_ads: true
    });
  </script>
</head>
  <body>
    <nav class="navbar navbar-default">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">TechTinkering</a>
    </div>

    <div id="navbar" class="collapse navbar-collapse navbar-right">
      <ul class="nav navbar-nav navbar-right contact-buttons">
        <li>
          <!-- From: http://www.buttonshut.com/Get-Button-Huts-Code/Twitter-Buttons-1124.html -->
          <a href="http://twitter.com/TechTinkering" title="@TechTinkering on Twitter">
            <img class="bannerIcon" src="/images/twitter-button-36.png" alt="@techtinkering on Twitter"/>
          </a>
        </li>
        <li>
          <!-- From: http://www.buttonshut.com/Get-Button-Huts-Code/Youtube-Buttons-831.html -->
          <a href="http://youtube.com/techtinkering" title="TechTinkering's YouTube Channel">
            <img class="bannerIcon" src="/images/youtube-small-square-32.png" alt="YouTube Channel"/>
          </a>
        </li>
        <li>
          <!-- From: http://www.graphicsfuel.com/2011/05/email-icon-psd/ -->
          <a href="mailto:techtinkering@vlifesystems.com" title="Email us, we'd love to hear from you">
            <img class="bannerIcon" src="/images/email.png" alt="Email"/>
          </a>
        </li>
        <li>
          <a href="https://github.com/lawrencewoodman/techtinkering.com" title="Fork TechTinkering On GitHub ">
            <img class="bannerIcon" src="/images/octocat_fluid.png" "TechTinkering Repo on GitHub"/>
          </a>
        </li>
        <li>
          <a href="http://feeds.feedburner.com/TechTinkering" title="Subscribe to our RSS Feed">
            <img class="bannerIcon" src="/images/feed-icon-28x28.png" alt="RSS Feed"/>
          </a>
        </li>
      </ul>

    </div><!--/.nav-collapse -->
  </div>
</nav>
    <div id="content" class="container">
      <div class="row margin-buffer">
  <div class="col-md-12">
    <article itemscope itemtype="http://schema.org/BlogPosting">
      <header>
        <a href="/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing/" title="Beware of Immutable Lists for F# Parallel Processing">
          <h1 itemprop="headline name">Beware of Immutable Lists for F# Parallel Processing</h1>
        </a>
        <div class="pull-right">
          <ul class="share-buttons">
  <li><a href="https://twitter.com/intent/tweet?source=http%3A%2F%2Ftechtinkering.com&text=:%20http%3A%2F%2Ftechtinkering.com&via=TechTinkering" target="_blank" title="Tweet" onclick="window.open('https://twitter.com/intent/tweet?text=' + encodeURIComponent(document.title) + ':%20'  + encodeURIComponent(document.URL)); return false;"><img alt="Tweet" src="/img/social_flat_rounded_rects_svg/Twitter.svg" /></a></li>
  <li><a href="http://www.reddit.com/submit?url=http%3A%2F%2Ftechtinkering.com&title=" target="_blank" title="Submit to Reddit" onclick="window.open('http://www.reddit.com/submit?url=' + encodeURIComponent(document.URL) + '&title=' +  encodeURIComponent(document.title)); return false;"><img alt="Submit to Reddit" src="/img/social_flat_rounded_rects_svg/Reddit.svg" /></a></li>
  <li><a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Ftechtinkering.com&quote=" title="Share on Facebook" target="_blank" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(document.URL) + '&quote=' + encodeURIComponent(document.URL)); return false;"><img alt="Share on Facebook" src="/img/social_flat_rounded_rects_svg/Facebook.svg" /></a></li>
  <li><a href="mailto:?subject=&body=:%20http%3A%2F%2Ftechtinkering.com" target="_blank" title="Send email" onclick="window.open('mailto:?subject=' + encodeURIComponent(document.title) + '&body=' +  encodeURIComponent(document.URL)); return false;"><img alt="Send email" src="/img/social_flat_rounded_rects_svg/Email.svg" /></a></li>
</ul>
        </div>
          <time itemprop="datePublished"
                datetime="2014-04-19">
            19 April 2014
          </time>
          &nbsp; / &nbsp;
        <span itemscope itemprop="publisher"
              itemtype="http://schema.org/Organization">
          <meta itemprop="name" content="TechTinkering" />
          <meta itemprop="url" content="http://techtinkering.com" />
        </span>
        <span itemscope itemprop="author" itemtype="http://schema.org/Person">
          <a rel="author" itemprop="url" href="https://lawrencewoodman.github.io">
            <span itemprop="name">Lawrence Woodman</span>
          </a>
        </span>
        &nbsp; / &nbsp;
          <a href="/articles/tag/f/">F#</a>
          &nbsp; &nbsp;
          <a href="/articles/tag/parallelprocessing/">Parallel Processing</a>
          &nbsp; &nbsp;
          <a href="/articles/tag/programming/">Programming</a>
          &nbsp; &nbsp;
      </header>
      <br />
      <div itemprop="articleBody">
        <p>With F#, the <em>list</em> often feels like the default choice of data structure.  It is immutable and hence easy to reason about, however its use can come at a great cost.  If you are using lists to process large amounts of data, then a lot of time will be spent creating objects and garbage collecting.  When I stress tested lists with F#, it became clear that this can cause a major synchronization issue when parallel processing.  In fact, I was often seeing programs written in parallel which were effectively just context switching between threads rather than running in parallel.</p>
<h1>Investigating an Answer</h1>
<p>I tried to find an answer to this problem and posted on stackoverflow: <a href="http://stackoverflow.com/questions/22778028/how-to-execute-a-function-that-creates-a-lot-of-objects-in-parallel">How to execute a function, that creates a lot of objects, in parallel?</a>.  This didn't lead to an answer, which left me with two options:</p>
<ol>
<li>Keep the immutable lists but use a serialization strategy to bring data in and out of a program that runs as a single processes.  Then use another program to distribute that data to each program and run them in parallel.</li>
<li>Switch to mutable data structures to reduce the synchronization problems and time spent creating objects and garbage collecting.</li>
</ol>
<p>My preference is for immutable data structures, however serializing data in and out can be slow depending on what is being processed and this ugly hack removed much of the beauty and transparency of using immutable data structures.  I therefore decided to investigate the effect of switching to mutable data structures to see what a difference this would make.  The difference was huge.</p>
<h1>An Example Program Using Immutable Lists</h1>
<p>The script below (<code>program-noclass-list.fsx</code>) is a very basic data categorizer which relies on a field having a certain value as a rule to determine if this will predict a category.</p>
<pre><code class="language-fsharp">// Filename: program-noclass-list.fsx
open System

type CategoryAssessment =
    { fieldIndex: int
      value: int
      ruleAssessments: list&lt;int&gt; }

let InitAssessment categorizeFields rules =
    let ruleAssessments = List.init (List.length rules) (fun x -&gt; 0)
    List.map (fun categorizeField -&gt;
                 let fieldIndex, categoryValue = categorizeField
                 { CategoryAssessment.fieldIndex = fieldIndex;
                   value = categoryValue;
                   ruleAssessments = ruleAssessments })
             categorizeFields

let AssessCategory ruleMatches (row : int[]) categoryAssessment =
    let fieldIndex = categoryAssessment.fieldIndex
    let categoryValue = categoryAssessment.value
    let categoryMatch = categoryValue = row.[fieldIndex]
    let newRuleAssessments =
        List.map2 (fun ruleAssessment ruleMatch -&gt;
                       if ruleMatch = categoryMatch then
                           ruleAssessment + 1
                       else
                           ruleAssessment)
                  categoryAssessment.ruleAssessments
                  ruleMatches
    { categoryAssessment with ruleAssessments = newRuleAssessments }

let MatchRule (row : int[]) rule =
    let fieldIndex, eqVal = rule
    row.[fieldIndex] = eqVal

let Assess categorizeFields rules input =
  printfn &quot;START - Assess&quot;
  let d =
    Array.fold (fun categoryAssessment row -&gt;
                 let ruleMatches = List.map (MatchRule row) rules
                 List.map (AssessCategory ruleMatches row) categoryAssessment)
               (InitAssessment categorizeFields rules)
               input
  printfn &quot;END - Assess&quot;
  d

let JoinAssessments assessments =
    let numAssessments = Array.length assessments
    Array.fold (fun accAssessment assessment -&gt;
                    List.map2 (fun accCategory category -&gt;
                                   let newRuleAssessments =
                                       List.map2 (+)
                                                 accCategory.ruleAssessments
                                                 category.ruleAssessments
                                   { accCategory with
                                         ruleAssessments = newRuleAssessments })
                              accAssessment
                              assessment)
               assessments.[0]
               assessments.[1..(numAssessments-1)]


let numRecords = 1000000
let numFields = 20
let numSplits = 10
let numRules = 10000
let inputs = Array.create numSplits
                          [| for i in 1 .. (numRecords / numSplits) -&gt;
                                [| for j in 1 .. numFields -&gt;
                                       (i % 10) + j |] |]
let categorizeFields = [ (1, 6); (2, 3); (2, 4); (3, 2) ]
let rules = [ for i in 1 .. numRules -&gt; (i % numFields, i) ]

let assessments =
    Array.Parallel.map (Assess categorizeFields rules) inputs
    |&gt; JoinAssessments
printfn &quot;Assessments: %A&quot; assessments
0
</code></pre>
<h1>Improvements</h1>
<p>I made two main improvements, both involving moving to arrays.  The programs can be seen in full at the end of this article and the benchmarks in the next section.</p>
<dl>
  <dt>program-no-class-array.fsx</dt>
  <dd>First I switched all the lists to arrays.  This would reduce the amount of memory allocation and garbage collection and hence synchronization issues.  Although arrays are mutable, I used them in an immutable way.</dd>
  <dt>program-no-class-mutable-array.fsx</dt>
  <dd>Secondly I made the record field for the arrays mutable and again reduced the time creating objects and garbage collecting.</dd>
  <dt>program-class-mutable-array.fsx</dt>
  <dd>The switch to mutable arrays made a big difference, but I wanted to regain some control of the mutability and hence created a <em>class</em> to improve access control.</dd>
</dl>
<h1>Benchmarks</h1>
<p>You can see below that the biggest difference was made by switching from lists to arrays and that still more could be done by moving to mutable arrays.</p>
<table class="neatTable">
  <tr><th>Filename</th><th>User time</th><th>Elapsed time</th><th>CPU usage</th></tr>
  <tr><td>program-noclass-list.fsx</td><td>1568.44</td><td>23:11.65</td><td>115%</td></tr>
  <tr><td>program-noclass-array.fsx</td><td>83.09</td><td>0:59.14</td><td>142%</td></tr>
  <tr><td>program-class-mutable-array.fsx</td><td>60.57</td><td>0:35.64</td><td>172%</td></tr>
  <tr><td>program-noclass-mutable-array.fsx</td><td>55.82</td><td>0:33.19</td><td>172%</td></tr>
</table>
<p>For those interested here are the benchmarks for the same programs run on a single thread (by changing the <code>numSplits</code> line to equal <code>1</code>).  This demonstrates the problem with <code>program-noclass-list.fsx</code> as it actually runs quicker with a single thread than it does in parallel.  It also shows the problem with lists in general where performance is an issue.</p>
<table class="neatTable">
  <tr><th>Filename</th><th>User time</th><th>Elapsed time</th><th>CPU usage</th></tr>
  <tr><td>program-noclass-list.fsx</td><td>1154.09</td><td>20:02.16</td><td>99%</td></tr>
  <tr><td>program-noclass-array.fsx</td><td>81.99</td><td>1:23.42</td><td>99%</td></tr>
  <tr><td>program-class-mutable-array.fsx</td><td>61.73</td><td>1:06.60</td><td>94%</td></tr>
  <tr><td>program-noclass-mutable-array.fsx</td><td>51.83</td><td>0:52.87</td><td>100%</td></tr>
</table>
<h2>Where Now?</h2>
<p>It is important to pick the correct data structures for the job at hand.  As <a href="http://en.wikipedia.org/wiki/Niklaus_Wirth">Wirth</a> said &quot;Algorithms + Data Structures = Programs&quot;.  While <em>list</em>s are a great default data structure in F#, where performance is an issue it can be seen how important it is to look beyond this, particularly when using multiple threads.</p>
<hr />
<h1>Full Source Code for Programs</h1>
<h2>program-noclass-array.fsx</h2>
<pre><code class="language-fsharp">// Filename: program-noclass-array.fsx
open System

type CategoryAssessment =
    { fieldIndex: int
      value: int
      ruleAssessments: int[] }

let InitAssessment categorizeFields rules =
    let ruleAssessments = Array.create (Array.length rules) 0
    Array.map (fun categorizeField -&gt;
                   let fieldIndex, categoryValue = categorizeField
                   { CategoryAssessment.fieldIndex = fieldIndex;
                     value = categoryValue;
                     ruleAssessments = ruleAssessments })
              categorizeFields

let AssessCategory ruleMatches (row : int[]) categoryAssessment =
    let fieldIndex = categoryAssessment.fieldIndex
    let categoryValue = categoryAssessment.value
    let categoryMatch = categoryValue = row.[fieldIndex]
    let newRuleAssessments =
        Array.map2 (fun ruleAssessment ruleMatch -&gt;
                        if ruleMatch = categoryMatch then
                            ruleAssessment + 1
                        else
                            ruleAssessment)
                   categoryAssessment.ruleAssessments
                   ruleMatches
    { categoryAssessment with ruleAssessments = newRuleAssessments }

let MatchRule (row : int[]) rule =
    let fieldIndex, eqVal = rule
    row.[fieldIndex] = eqVal

let Assess categorizeFields rules input =
  printfn &quot;START - Assess&quot;
  let d =
    Array.fold (fun categoryAssessment row -&gt;
                 let ruleMatches = Array.map (MatchRule row) rules
                 Array.map (AssessCategory ruleMatches row) categoryAssessment)
               (InitAssessment categorizeFields rules)
               input
  printfn &quot;END - Assess&quot;
  d

let JoinAssessments assessments =
    let numAssessments = Array.length assessments
    Array.fold (fun accAssessment assessment -&gt;
                    Array.map2 (fun accCategory category -&gt;
                                    let newRuleAssessments =
                                        Array.map2 (+)
                                                   accCategory.ruleAssessments
                                                   category.ruleAssessments
                                    { accCategory with
                                          ruleAssessments = newRuleAssessments })
                               accAssessment
                               assessment)
               assessments.[0]
               assessments.[1..(numAssessments-1)]


let numRecords = 1000000
let numFields = 20
let numSplits = 10
let numRules = 10000
let inputs = Array.create numSplits
                          [| for i in 1 .. (numRecords / numSplits) -&gt;
                                [| for j in 1 .. numFields -&gt;
                                       (i % 10) + j |] |]
let categorizeFields = [| (1, 6); (2, 3); (2, 4); (3, 2) |]
let rules = [| for i in 1 .. numRules -&gt; (i % numFields, i) |]

let assessments =
    Array.Parallel.map (Assess categorizeFields rules) inputs
    |&gt; JoinAssessments
printfn &quot;Assessments: %A&quot; assessments
0
</code></pre>
<h2>program-noclass-mutable-array.fsx</h2>
<pre><code class="language-fsharp">// Filename: program-noclass-mutable-array.fsx
open System

type CategoryAssessment =
    { fieldIndex: int
      value: int
      mutable ruleAssessments: int[] }

let InitAssessment categorizeFields rules =
    Array.map (fun categorizeField -&gt;
                   let fieldIndex, categoryValue = categorizeField
                   let ruleAssessments = Array.create (Array.length rules) 0
                   { CategoryAssessment.fieldIndex = fieldIndex;
                     value = categoryValue;
                     ruleAssessments = ruleAssessments })
              categorizeFields

let AssessCategory ruleMatches (row : int[]) categoryAssessment =
    let fieldIndex = categoryAssessment.fieldIndex
    let categoryValue = categoryAssessment.value
    let categoryMatch = categoryValue = row.[fieldIndex]
    Array.iteri (fun i ruleMatch -&gt;
                     if ruleMatch = categoryMatch then
                         categoryAssessment.ruleAssessments.[i] &lt;-
                             categoryAssessment.ruleAssessments.[i] + 1)
                ruleMatches

let MatchRule (row : int[]) rule =
    let fieldIndex, eqVal = rule
    row.[fieldIndex] = eqVal

let Assess categorizeFields rules input =
      let assessment = InitAssessment categorizeFields rules
      printfn &quot;START - Assess&quot;
      Array.iter (fun row -&gt;
                      let ruleMatches = Array.map (MatchRule row) rules
                      Array.iter (AssessCategory ruleMatches row) assessment)
                 input
      printfn &quot;END - Assess&quot;
      assessment

let JoinAssessments assessments =
    let numAssessments = Array.length assessments
    Array.fold (fun accAssessment assessment -&gt;
                    Array.map2 (fun accCategory category -&gt;
                                    let newRuleAssessments =
                                        Array.map2 (+)
                                                   accCategory.ruleAssessments
                                                   category.ruleAssessments
                                    { accCategory with
                                          ruleAssessments = newRuleAssessments })
                               accAssessment
                               assessment)
               assessments.[0]
               assessments.[1..(numAssessments-1)]


let numRecords = 1000000
let numFields = 20
let numSplits = 10
let numRules = 10000
let inputs = Array.create numSplits
                          [| for i in 1 .. (numRecords / numSplits) -&gt;
                                [| for j in 1 .. numFields -&gt;
                                       (i % 10) + j |] |]
let categorizeFields = [| (1, 6); (2, 3); (2, 4); (3, 2) |]
let rules = [| for i in 1 .. numRules -&gt; (i % numFields, i) |]

let assessments =
    Array.Parallel.map (Assess categorizeFields rules) inputs
    |&gt; JoinAssessments
printfn &quot;Assessments: %A&quot; assessments
0
</code></pre>
<h2>program-class-mutable-array.fsx</h2>
<pre><code class="language-fsharp">// Filename: program-class-mutable-array.fsx
open System

type CategoryAssessment(fieldIndex : int,
                        categoryValue : int,
                        numRules : int) = class
    let mutable ruleAssessments = Array.create numRules 0
    member x.FieldIndex = fieldIndex
    member x.Value = categoryValue
    member x.RuleAssessments = ruleAssessments
    member x.IsSimilar(otherCategoryAssessment : CategoryAssessment) =
        x.FieldIndex = otherCategoryAssessment.FieldIndex &amp;&amp;
        x.Value = otherCategoryAssessment.Value &amp;&amp;
        Array.length ruleAssessments =
            Array.length otherCategoryAssessment.RuleAssessments
    member x.Merge(otherCategoryAssessment : CategoryAssessment) =
        if x.IsSimilar otherCategoryAssessment then
            ruleAssessments &lt;- Array.map2 (+)
                                          ruleAssessments
                                          otherCategoryAssessment.RuleAssessments
        else
            failwith &quot;ERROR: Can't merge with other CategoryAssessment&quot;
    member x.UpRuleAssessment(index) =
        ruleAssessments.[index] &lt;- ruleAssessments.[index] + 1
    override this.ToString() =
        sprintf &quot;{fieldIndex = %d; value = %d; ruleAssessments = %A }&quot;
                this.FieldIndex
                this.Value
                this.RuleAssessments
end


let InitAssessment categorizeFields rules =
    List.map (fun categorizeField -&gt;
                  let fieldIndex, categoryValue = categorizeField
                  new CategoryAssessment(fieldIndex,
                                         categoryValue, Array.length rules))
             categorizeFields
    |&gt; List.toArray

let AssessCategory ruleMatches
                   (row : int[])
                   (categoryAssessment : CategoryAssessment) =
    let fieldIndex = categoryAssessment.FieldIndex
    let categoryValue = categoryAssessment.Value
    let categoryMatch = categoryValue = row.[fieldIndex]
    Array.iteri  (fun i ruleMatch -&gt;
                      if ruleMatch = categoryMatch then
                          categoryAssessment.UpRuleAssessment i)
                 ruleMatches

let MatchRule (row : int[]) rule =
    let fieldIndex, eqVal = rule
    row.[fieldIndex] = eqVal

let Assess categorizeFields rules input =
    printfn &quot;START - Assess&quot;
    let categoryAssessments = InitAssessment categorizeFields rules
    Array.iter (fun row -&gt;
                    let ruleMatches = Array.map (MatchRule row) rules
                    Array.iter (AssessCategory ruleMatches row)
                               categoryAssessments)
               input
    printfn &quot;END - Assess&quot;
    categoryAssessments

let JoinAssessments assessments =
    let numAssessments = Array.length assessments
    Array.fold (fun accAssessment assessment -&gt;
                    Array.iter2 (fun (accCategory : CategoryAssessment)
                                     (category : CategoryAssessment) -&gt;
                                     accCategory.Merge category)
                                accAssessment
                                assessment
                    accAssessment)
               assessments.[0]
               assessments.[1..(numAssessments-1)]


let numRecords = 1000000
let numFields = 20
let numSplits = 1
let numRules = 10000
let inputs = Array.create numSplits
                          [| for i in 1 .. (numRecords / numSplits) -&gt;
                                [| for j in 1 .. numFields -&gt;
                                       (i % 10) + j |] |]
let categorizeFields = [ (1, 6); (2, 3); (2, 4); (3, 2) ]
let rules = [| for i in 1 .. numRules -&gt; (i % numFields, i) |]
let assessments =
    Array.Parallel.map (Assess categorizeFields rules) inputs
    |&gt; JoinAssessments
printfn &quot;Assessments: %A&quot; assessments
0
</code></pre>
      </div>
    </article>
  </div>
</div>

  <div class="row">
    <div class="col-md-12">
      <div id="cclicence">
        <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">
          <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" />
        </a>
        <br />
        <span xmlns:dct="http://purl.org/dc/terms/" property="dct:title">Beware of Immutable Lists for F# Parallel Processing</span>
        by <a xmlns:cc="http://creativecommons.org/ns#" href="http://techtinkering.com/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing/" property="cc:attributionName" rel="cc:attributionURL">Lawrence Woodman</a>
       is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.
      </div>
    </div>
  </div>

    <div class="row">
      <div class="col-md-12">
        <h2>Related Articles</h2>
      </div>
    </div>
    <div class="row margin-buffer">
  <div class="col-md-12">
        <header>
  <h3><a href="/articles/6502-machine-language-tables-and-aids/">6502 Machine Language Tables and Aids</a></h3>
  <span class="post-meta">
      <time datetime="2019-12-04">
         4 December 2019
      </time>
      &nbsp; / &nbsp;
      <a href="/articles/tag/assembly/">Assembly</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/programming/">Programming</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/retro/">Retro</a>
      &nbsp; &nbsp;
  </span>
</header>
<div>
  When programming using machine code there are a few useful aids that can make it easier to do.  I have created a couple of tables for the 6502 that can make the process easier.  They are based on table...
  &nbsp;
  <a class="readMore" href="/articles/6502-machine-language-tables-and-aids/">Read More</a>
</div>
        <header>
  <h3><a href="/articles/tokenize-detokenize-commodore-basic-programs-using-petcat/">Tokenize/De-tokenize Commodore Basic Programs Using petcat</a></h3>
  <span class="post-meta">
      <time datetime="2019-11-21">
        21 November 2019
      </time>
      &nbsp; / &nbsp;
      <a href="/articles/tag/commodore/">Commodore</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/programming/">Programming</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/retro/">Retro</a>
      &nbsp; &nbsp;
  </span>
</header>
<div>
  petcat is a utility provided with the VICE Commodore emulator that you can use to convert Basic source code contained in ASCII text files to .PRG files or vice versa.  It is also able to convert ASCII ...
  &nbsp;
  <a class="readMore" href="/articles/tokenize-detokenize-commodore-basic-programs-using-petcat/">Read More</a>
</div>
        <header>
  <h3><a href="/articles/changing-screen-dimensions-on-the-commodore-vic-20/">Changing Screen Dimensions on the Commodore VIC-20</a></h3>
  <span class="post-meta">
      <time datetime="2019-11-08">
         8 November 2019
      </time>
      &nbsp; / &nbsp;
      <a href="/articles/tag/commodore/">Commodore</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/programming/">Programming</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/retro/">Retro</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/vic-20/">VIC-20</a>
      &nbsp; &nbsp;
  </span>
</header>
<div>
  To make the most of the limited amount of memory on the VIC-20, we can increase and decrease the screen size depending on our program's priorities and what we want to achieve.  If we increase the size ...
  &nbsp;
  <a class="readMore" href="/articles/changing-screen-dimensions-on-the-commodore-vic-20/">Read More</a>
</div>
        <header>
  <h3><a href="/articles/moving-the-picture-origin-on-the-commodore-vic-20/">Moving the Picture Origin on the Commodore VIC-20</a></h3>
  <span class="post-meta">
      <time datetime="2019-10-03">
         3 October 2019
      </time>
      &nbsp; / &nbsp;
      <a href="/articles/tag/commodore/">Commodore</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/programming/">Programming</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/retro/">Retro</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/vic-20/">VIC-20</a>
      &nbsp; &nbsp;
  </span>
</header>
<div>
  The VIC-20's VIC chip provides a simple yet flexible video display and one of the features that can be quite useful is the ability to alter the picture origin on the screen.  This feature allows us to ...
  &nbsp;
  <a class="readMore" href="/articles/moving-the-picture-origin-on-the-commodore-vic-20/">Read More</a>
</div>
        <header>
  <h3><a href="/articles/40-columns-in-basic-on-the-commodore-vic-20/">40 Columns in Basic on the Commodore VIC-20</a></h3>
  <span class="post-meta">
      <time datetime="2019-08-23">
        23 August 2019
      </time>
      &nbsp; / &nbsp;
      <a href="/articles/tag/commodore/">Commodore</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/programming/">Programming</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/retro/">Retro</a>
      &nbsp; &nbsp;
      <a href="/articles/tag/vic-20/">VIC-20</a>
      &nbsp; &nbsp;
  </span>
</header>
<div>
  There are a number of programs that allow you to use 40 columns of text from Basic on a Commodore VIC-20.  This can be useful as by default the Vic's screen is 22 columns by 23 rows.  They are supplied...
  &nbsp;
  <a class="readMore" href="/articles/40-columns-in-basic-on-the-commodore-vic-20/">Read More</a>
</div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <form id="email-subscribe" action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open('https://feedburner.google.com/fb/a/mailverify?uri=TechTinkering', 'popupwindow', 'scrollbars=yes,width=550,height=520');return true">
  <p>Sign up to get new articles straight to your inbox.</p>
  <p><input type="text" style="width:180px" name="email" placeholder="Email address"/>
  <input type="hidden" value="TechTinkering" name="uri"/>
  <input type="hidden" name="loc" value="en_US"/>
  <input class="subscribe-button" type="submit" value="Subscribe" /></p>
  <p>Delivered by <a href="https://feedburner.google.com" target="_blank">FeedBurner</a></p>
</form>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
      var disqus_shortname = 'techtinkering';
      var disqus_identifier = '/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing/';
      var disqus_url = 'http://techtinkering.com/2014/04/19/beware-of-immutable-lists-for-fsharp-parallel-processing/';

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="https://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</div>
    </div>

    <footer>
  <nav class="navbar navbar-default">
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <strong>Legal:</strong> &nbsp;
          <a href="/terms/">T & C</a>, &nbsp; &nbsp;
          <a href="/privacy/">Privacy Policy</a>
        </div>
      </div>
    </div>
  </nav>
</footer>
  </body>
</html>